# archiver web container nginx config
# Optional auth: extracts email from oauth2-proxy cookie if present,
# falls through to anonymous for unauthenticated users.

map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
}

resolver 127.0.0.11 valid=10s;

set_real_ip_from 0.0.0.0/0;
real_ip_header X-Real-IP;

server {
    listen 8080;
    server_name _;

    root /usr/share/nginx/html;
    absolute_redirect off;

    # ── Optional auth: try Google cookie, fall through to anonymous ──
    error_page 401 = @anon;
    location @anon {
        proxy_pass http://frontend:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        # No X-Auth-Email header — user is anonymous
    }

    # ── OAuth2 Proxy — Google (port 4180) ──
    location /oauth2-google/ {
        proxy_pass http://oauth2-proxy-google:4180;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Auth-Request-Redirect $request_uri;
    }

    location = /oauth2-google/auth {
        internal;
        proxy_pass http://oauth2-proxy-google:4180;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Content-Length "";
        proxy_pass_request_body off;
    }

    # ── OAuth2 Proxy — Apple (port 4181) ──
    location /oauth2-apple/ {
        proxy_pass http://oauth2-proxy-apple:4181;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Auth-Request-Redirect $request_uri;
    }

    location = /oauth2-apple/auth {
        internal;
        proxy_pass http://oauth2-proxy-apple:4181;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Content-Length "";
        proxy_pass_request_body off;
    }

    # ── Sign-in page (unprotected) ──
    location = /signin {
        try_files /signin.html =404;
    }

    # ── SSE events — long-lived, no buffering ──
    location ~ ^/api/records/events$ {
        auth_request /oauth2-google/auth;
        auth_request_set $auth_email $upstream_http_x_auth_request_email;

        # Fall through to anonymous if not authenticated
        error_page 401 = @sse_anon;

        proxy_pass http://frontend:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Auth-Email $auth_email;
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 86400;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        chunked_transfer_encoding off;
    }

    location @sse_anon {
        proxy_pass http://frontend:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 86400;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        chunked_transfer_encoding off;
    }

    # ── All other requests → SvelteKit with optional auth ──
    location / {
        auth_request /oauth2-google/auth;
        auth_request_set $auth_email $upstream_http_x_auth_request_email;

        proxy_pass http://frontend:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Auth-Email $auth_email;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
    }
}
