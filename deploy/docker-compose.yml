services:
  backend:
    image: dockerregistry.icomb.place/archiver/backend:latest
    user: "${CONTAINER_USER:-1012:1012}"
    ports:
      - "8098:8080"
    volumes:
      - archiver_store:/data/archiver_store
    environment:
      SPRING_PROFILES_ACTIVE: prod
      DATASOURCE_URL: jdbc:postgresql://${DB_HOST}:5432/${DB_NAME}?stringtype=unspecified
      DATASOURCE_USERNAME: ${DB_USER}
      DATASOURCE_PASSWORD: ${DB_PASSWORD}
      ARCHIVER_STORAGE_ROOT: /data/archiver_store
      ARCHIVER_PROCESSOR_TOKEN: ${PROCESSOR_TOKEN}
      ARCHIVER_ESCALATION_CONFIDENCE_MIN: "0.70"
      ARCHIVER_ESCALATION_TEXT_MIN_CHARS: "200"
      ARCHIVER_ESCALATION_JUNK_RATIO_MAX: "0.25"
      ARCHIVER_ESCALATION_ENABLE_ABBYY: "false"
      SECRET_KEY: ${SECRET_KEY}
    restart: unless-stopped

  frontend:
    image: dockerregistry.icomb.place/archiver/frontend:latest
    user: "${CONTAINER_USER:-1012:1012}"
    ports:
      - "8099:3000"
    environment:
      BACKEND_URL: http://backend:8080
      ORIGIN: https://archiver.icomb.place
    depends_on:
      - backend
    restart: unless-stopped

  scraper-cz:
    image: dockerregistry.icomb.place/archiver/scraper-cz:latest
    user: "${CONTAINER_USER:-1012:1012}"
    environment:
      BACKEND_URL: http://backend:8080
    depends_on:
      - backend
    restart: "no"

  ocr-worker-paddle:
    image: dockerregistry.icomb.place/archiver/ocr-worker-paddle:latest
    user: "${CONTAINER_USER:-1012:1012}"
    runtime: nvidia
    environment:
      HOME: /tmp
      BACKEND_URL: http://backend:8080
      PROCESSOR_TOKEN: ${PROCESSOR_TOKEN}
      NVIDIA_VISIBLE_DEVICES: all
    depends_on:
      - backend
    restart: unless-stopped

  pdf-worker:
    image: dockerregistry.icomb.place/archiver/pdf-worker:latest
    user: "${CONTAINER_USER:-1012:1012}"
    environment:
      BACKEND_URL: http://backend:8080
      PROCESSOR_TOKEN: ${PROCESSOR_TOKEN}
    depends_on:
      - backend
    restart: unless-stopped

  translate-worker:
    image: dockerregistry.icomb.place/archiver/translate-worker:latest
    user: "${CONTAINER_USER:-1012:1012}"
    environment:
      HOME: /tmp
      BACKEND_URL: http://backend:8080
      PROCESSOR_TOKEN: ${PROCESSOR_TOKEN}
    depends_on:
      - backend
    restart: unless-stopped

  # entity-worker:
  #   image: dockerregistry.icomb.place/archiver/entity-worker:latest
  #   environment:
  #     BACKEND_URL: http://backend:8080
  #     PROCESSOR_TOKEN: ${PROCESSOR_TOKEN}
  #   depends_on:
  #     - backend
  #   restart: unless-stopped

volumes:
  archiver_store:
    external: true
