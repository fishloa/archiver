services:
  web:
    image: dockerregistry.icomb.place/archiver/web:latest
    ports:
      - "8099:8080"
    depends_on:
      - frontend
      - oauth2-proxy-google
      - oauth2-proxy-apple
    restart: unless-stopped

  oauth2-proxy-google:
    image: quay.io/oauth2-proxy/oauth2-proxy:latest
    environment:
      OAUTH2_PROXY_PROVIDER: google
      OAUTH2_PROXY_CLIENT_ID: ${OAUTH2_PROXY_CLIENT_ID}
      OAUTH2_PROXY_CLIENT_SECRET: ${OAUTH2_PROXY_CLIENT_SECRET}
      OAUTH2_PROXY_COOKIE_SECRET: ${OAUTH2_PROXY_COOKIE_SECRET}
      OAUTH2_PROXY_COOKIE_NAME: _oauth2_proxy
      OAUTH2_PROXY_COOKIE_DOMAINS: archiver.icomb.place
      OAUTH2_PROXY_COOKIE_SAMESITE: lax
      OAUTH2_PROXY_COOKIE_CSRF_PER_REQUEST: "true"
      OAUTH2_PROXY_COOKIE_CSRF_EXPIRE: 5m
      OAUTH2_PROXY_EMAIL_DOMAINS: "*"
      OAUTH2_PROXY_HTTP_ADDRESS: 0.0.0.0:4180
      OAUTH2_PROXY_PROXY_PREFIX: /oauth2-google
      OAUTH2_PROXY_UPSTREAM: static://200
      OAUTH2_PROXY_SKIP_PROVIDER_BUTTON: "true"
      OAUTH2_PROXY_SET_XAUTHREQUEST: "true"
      OAUTH2_PROXY_SESSION_STORE_TYPE: cookie
      OAUTH2_PROXY_REDIRECT_URL: https://archiver.icomb.place/oauth2-google/callback
    restart: unless-stopped

  oauth2-proxy-apple:
    image: dockerregistry.icomb.place/archiver/oauth2-proxy-apple:latest
    environment:
      APPLE_TEAM_ID: ${APPLE_TEAM_ID}
      APPLE_KEY_ID: ${APPLE_KEY_ID}
      APPLE_CLIENT_ID: ${APPLE_CLIENT_ID}
      APPLE_KEY_P8_B64: ${APPLE_KEY_P8_B64}
      OAUTH2_PROXY_PROVIDER: oidc
      OAUTH2_PROXY_OIDC_ISSUER_URL: https://appleid.apple.com
      OAUTH2_PROXY_CLIENT_ID: ${APPLE_CLIENT_ID}
      OAUTH2_PROXY_COOKIE_SECRET: ${OAUTH2_PROXY_COOKIE_SECRET}
      OAUTH2_PROXY_COOKIE_NAME: _oauth2_proxy
      OAUTH2_PROXY_COOKIE_DOMAINS: archiver.icomb.place
      OAUTH2_PROXY_COOKIE_SAMESITE: lax
      OAUTH2_PROXY_COOKIE_CSRF_PER_REQUEST: "true"
      OAUTH2_PROXY_COOKIE_CSRF_EXPIRE: 5m
      OAUTH2_PROXY_EMAIL_DOMAINS: "*"
      OAUTH2_PROXY_HTTP_ADDRESS: 0.0.0.0:4181
      OAUTH2_PROXY_PROXY_PREFIX: /oauth2-apple
      OAUTH2_PROXY_UPSTREAM: static://200
      OAUTH2_PROXY_SKIP_PROVIDER_BUTTON: "true"
      OAUTH2_PROXY_SET_XAUTHREQUEST: "true"
      OAUTH2_PROXY_SESSION_STORE_TYPE: cookie
      OAUTH2_PROXY_CODE_CHALLENGE_METHOD: S256
      OAUTH2_PROXY_OIDC_EXTRA_AUDIENCES: ${APPLE_CLIENT_ID}
      OAUTH2_PROXY_REDIRECT_URL: https://archiver.icomb.place/oauth2-apple/callback
    restart: unless-stopped

  backend:
    image: dockerregistry.icomb.place/archiver/backend:latest
    user: "${CONTAINER_USER:-1012:1012}"
    volumes:
      - archiver_store:/data/archiver_store
    environment:
      SPRING_PROFILES_ACTIVE: prod
      DATASOURCE_URL: jdbc:postgresql://${DB_HOST}:5432/${DB_NAME}?stringtype=unspecified
      DATASOURCE_USERNAME: ${DB_USER}
      DATASOURCE_PASSWORD: ${DB_PASSWORD}
      ARCHIVER_STORAGE_ROOT: /data/archiver_store
      ARCHIVER_PROCESSOR_TOKEN: ${PROCESSOR_TOKEN}
      ARCHIVER_ESCALATION_CONFIDENCE_MIN: "0.70"
      ARCHIVER_ESCALATION_TEXT_MIN_CHARS: "200"
      ARCHIVER_ESCALATION_JUNK_RATIO_MAX: "0.25"
      ARCHIVER_ESCALATION_ENABLE_ABBYY: "false"
      SECRET_KEY: ${SECRET_KEY}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
    restart: unless-stopped

  frontend:
    image: dockerregistry.icomb.place/archiver/frontend:latest
    user: "${CONTAINER_USER:-1012:1012}"
    environment:
      BACKEND_URL: http://backend:8080
      ORIGIN: https://archiver.icomb.place
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
    depends_on:
      - backend
    restart: unless-stopped

  scraper-cz:
    image: dockerregistry.icomb.place/archiver/scraper-cz:latest
    user: "${CONTAINER_USER:-1012:1012}"
    environment:
      BACKEND_URL: http://backend:8080
    depends_on:
      - backend
    restart: "no"

  ocr-worker-paddle:
    image: dockerregistry.icomb.place/archiver/ocr-worker-paddle:latest
    user: "${CONTAINER_USER:-1012:1012}"
    runtime: nvidia
    environment:
      HOME: /tmp
      BACKEND_URL: http://backend:8080
      PROCESSOR_TOKEN: ${PROCESSOR_TOKEN}
      NVIDIA_VISIBLE_DEVICES: all
    depends_on:
      - backend
    restart: unless-stopped
    deploy:
      replicas: 2

  pdf-worker:
    image: dockerregistry.icomb.place/archiver/pdf-worker:latest
    user: "${CONTAINER_USER:-1012:1012}"
    environment:
      BACKEND_URL: http://backend:8080
      PROCESSOR_TOKEN: ${PROCESSOR_TOKEN}
    depends_on:
      - backend
    restart: unless-stopped
    deploy:
      replicas: 2

  translate-worker:
    image: dockerregistry.icomb.place/archiver/translate-worker:latest
    user: "${CONTAINER_USER:-1012:1012}"
    runtime: nvidia
    environment:
      HOME: /tmp
      LOGNAME: worker
      HF_HOME: /root/.cache/huggingface
      NVIDIA_VISIBLE_DEVICES: all
      BACKEND_URL: http://backend:8080
      PROCESSOR_TOKEN: ${PROCESSOR_TOKEN}
    depends_on:
      - backend
    restart: unless-stopped
    deploy:
      replicas: 2

  embed-worker:
    image: dockerregistry.icomb.place/archiver/embed-worker:latest
    user: "${CONTAINER_USER:-1012:1012}"
    environment:
      BACKEND_URL: http://backend:8080
      PROCESSOR_TOKEN: ${PROCESSOR_TOKEN}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
    depends_on:
      - backend
    restart: unless-stopped

  scraper-ebadatelna:
    image: dockerregistry.icomb.place/archiver/scraper-ebadatelna:latest
    user: "${CONTAINER_USER:-1012:1012}"
    environment:
      BACKEND_URL: http://backend:8080
      EBADATELNA_EMAIL: ${EBADATELNA_EMAIL:-}
      EBADATELNA_PASSWORD: ${EBADATELNA_PASSWORD:-}
    depends_on:
      - backend
    restart: "no"

  scraper-findbuch:
    image: dockerregistry.icomb.place/archiver/scraper-findbuch:latest
    user: "${CONTAINER_USER:-1012:1012}"
    environment:
      BACKEND_URL: http://backend:8080
      FINDBUCH_USERNAME: ${FINDBUCH_USERNAME:-}
      FINDBUCH_PASSWORD: ${FINDBUCH_PASSWORD:-}
    depends_on:
      - backend
    restart: "no"

  scraper-oesta:
    image: dockerregistry.icomb.place/archiver/scraper-oesta:latest
    user: "${CONTAINER_USER:-1012:1012}"
    environment:
      BACKEND_URL: http://backend:8080
    depends_on:
      - backend
    restart: "no"

  scraper-matricula:
    image: dockerregistry.icomb.place/archiver/scraper-matricula:latest
    user: "${CONTAINER_USER:-1012:1012}"
    environment:
      BACKEND_URL: http://backend:8080
    depends_on:
      - backend
    restart: "no"

  # entity-worker:
  #   image: dockerregistry.icomb.place/archiver/entity-worker:latest
  #   environment:
  #     BACKEND_URL: http://backend:8080
  #     PROCESSOR_TOKEN: ${PROCESSOR_TOKEN}
  #   depends_on:
  #     - backend
  #   restart: unless-stopped

volumes:
  archiver_store:
    external: true
